---
layout: default
title: Realtime Usage
---
<div class="status">
    <div id="map"></div>

    <script>
        var maxHeatPoints = 5000;

        var map = L.map('map', {
            fullscreenControl: true
        }).fitBounds([[75,-160], [-45,160]]);

        var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors | ' +
            'This product includes GeoLite data created by <a href="http://www.maxmind.com">MaxMind</a>',
        }).addTo(map);

        var heat = L.heatLayer([], {
            minOpacity: .4,
            radius: 20
        }).addTo(map);

        var heatmapData = [];

        function updateHeatmap(clients, active) {
            clients.map(function(client) {
                // client.kind[0].toUpperCase(); // version
                heatmapData.push([client.latitude, client.longitude]);
            });
            var limit = Math.min(maxHeatPoints, active);
            if (heatmapData.length > limit) {
                heatmapData.splice(0, heatmapData.length - limit);
            }
            heat.setLatLngs(heatmapData);
        }

        var info = L.control();

        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'infobox');
            return this._div;
        };

        info.update = function(active) {
            this._div.innerHTML = 'Estimated number of cgeo users in online mode: ' + active;
        };

        info.addTo(map);

        var ws = new WebSocket("wss://cgeo-status.herokuapp.com/api/locations?initial=" + maxHeatPoints);
        ws.onmessage = function(msg) {
            var data = JSON.parse(msg.data);
            updateHeatmap(data.clients, data.active);
            info.update(data.active);
        };
    </script>
</div>
