---
layout: default
title: Realtime Usage
---
<div class="status">
    <div id="map"></div>

    <script>
        var map = L.map('map', {
            fullscreenControl: true
        }).fitBounds([[75,-160], [-45,160]]);

        var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        var heat = L.heatLayer([], {
            minOpacity: .4,
            radius: 20
        }).addTo(map);

        var heatmapData = [];

        function updateHeatmap(clients) {
            clients.map(function(client) {
                // client.kind[0].toUpperCase(); // version
                heatmapData.push([client.latitude, client.longitude]);
            });
            if (heatmapData.length > 5000) {
                heatmapData.splice(heatmapData.length - 5000);
            }
            heat.setLatLngs(heatmapData);
        }

        $.getJSON('http://status.cgeo.org/api/recent-locations?limit=500', function(clients) {
                updateHeatmap(clients);
        });

        var ws = new WebSocket("wss://cgeo-status.herokuapp.com/api/locations");
        ws.onmessage = function(msg) {
            var data = JSON.parse(msg.data);
            updateHeatmap(data.clients);
        };
    </script>
</div>
